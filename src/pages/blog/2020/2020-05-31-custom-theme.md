---
title: '基于 Sass 的主题定制方案'
description: '本以为很简单的事情，然而……'
tags: ['css', 'sass', 'theme']
cover: '../../../images/blog/blank.jpg'
series: ''
draft: true
original: true
---

## 拷问：不就是换肤吗

微前端

匹配父容器样式

需求
- 支持定制主题色
- 应用级别的覆盖

## 审局：项目现状

代码仓库很大，包含数万行的 Sass 代码，以及数十万行的 TS 代码（不算空行）

颜色早已变量化，不过是直接引用的具体颜色

应用既独立存在，也以微前端形式嵌套于其他应用。

## 入局：技术选型

写死多套主题（直接 PASS）
- 短期内有效（不否认）
- 改造成本高
- 后续维护成本依然很高
- 只用于处理深色模式可以

Less
- modifyVars 可行
- 但我们用的不是 Less
- 为了这个迁移过去？大可不必……万一哪天变成 Less 受阻了，难不成在迁回 Sass？反复横跳

Sass
- Sass 无法在运行时修改变量，变量为块级作用域
- 全局替换作用范围不确定
- 存在异步模块，无法统一入口
- @use 和 @import 的异同

CSS Variables
- 需要支持 IE 11（虽然放弃 IE 已经提上日程，但毕竟还没）
- CSS Ponyfill 的问题
- 和 Sass 变量混用，Sass 函数无法作用于 CSS Variables

Theme Generator
- 要求基准样式都在一个 style 里。
- 组件库都是同步代码，问题不大；应用存在异步，不行。

最终需要满足的点：
- 基于 Sass（迁移成本太高）
- 构建期注入（运行时的改造成本高，且需求尚不强烈）
- 最好能够支持热更新

## 破局：脚本

方案

问题
- 本地开发无法使用
- 直接改源码的隐患

## 结局：Webpack Loader

挑战

无法根据 entry 来

未经 sass 解析无法获取 @use

## 复盘

随时做好准备，迎接未知的挑战（现学 webpack loader）

大型复杂项目，考虑问题必须全面。不仅看清眼下，更要着眼未来。0 到 1 的过程，要为之后 1 到 N 做好准备。

没能很好的支持热更新（webpack 依赖解析问题，迭代时间有限，后续考虑研究下 fork 一个 sass-loader，风险）

编译过程修改代码会被缓存，下次启动时如果命中缓存，可能会有问题，需要手动清理 `node_modules/.cache` 目录
