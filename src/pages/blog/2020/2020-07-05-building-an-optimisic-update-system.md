---
title: '设计一套乐观更新机制'
description: '做人呐，最重要的就是乐观啦'
tags: ['design']
cover: '../../../images/blog/blank.jpg'
series: ''
draft: true
original: true
---

## 终于，我又营业了

2020 年的上半年，比往年任何时候过得都快。转眼已经到了下半年，终于，我又营业了。

在正式开始写这篇文章之前，我还特意在百度、知乎、掘金等平台搜了一下「乐观更新」，发现相关的内容屈指可数，讲「乐观锁」的到是有不少。

那正好，就让我来填补一下这个空白吧。

## 什么是「乐观更新」

通常，客户端在发起 CRUD 请求之后，都需要等待服务端返回，然后再去更新视图。这逻辑非常合理，一点毛病没有。唯一的缺点，就是在等待服务端响应的时间里，客户端只能空等，直观感受就是：用户从交互结束，到看到结果，中间免不了会有一个可感知的延迟。稍微对用户体验有所追求的，都会在这个时候显示一个 Loading，让用户知道系统还在运行。这种做法，在逻辑上非常严谨

如果你体验过 Google 家的产品，你一定会惊叹于其交互的响应速度，那种按下按钮之后立刻得到结果的快感，就好像一切都发生在本地，根本不用等待接口响应一样。Google 之所以能做到这种程度，并不是因为它是 Google —— 一个掌握着浏览器、网络协议、V8 引擎等核心技术的互联网巨头。人家的方案非常简单：真就是不等待接口返回，请求发出去的同时，直接就把交互的结果体现到视图上。

这就是「乐观更新」：客户端假设请求必然成功，因此不等待接口的返回，直接对视图进行更新。

## 这么乐观，真的大丈夫吗？

并不是所有操作都可以通过「乐观更新」的方式来实现，需要有一些前提条件：

- 操作成功率非常高，大概率是不会返回失败的
- 接口正常响应的耗时很短
- 即便操作失败，或是误操作了，也可以轻易的撤销。

像发送一条消息、删除一个文件，这些都是可以考虑「乐观更新」的，能够大幅提升用户体验。

你能想象每发一条微信消息都会出现一个 Loading 的场景吗？Windows 10 已经默认把删除到回收站的确认框取消了你发现了吗？

反过来，像文件传输、鉴权相关的操作，就不适合「乐观更新」了。

你能想象迅雷还没开始下载就直接显示下载完毕了吗？或者用支付宝付款的时候，先显示支付成功，然后才告诉你余额不足吗？

## 要乐观，也要悲观

在一个状态良好的网络环境中（如 Wifi、4G），绝大部分的接口都能在短时间内得到成功的响应。因此客户端在发起请求的同时，完全可以大胆假设接口的返回一定是成功的。既然已经知道了返回的结果，那就不用非得等接口的消息了，可以直接进行后面的操作。

然而这一系列的操作，全都是基于一个假设，既然是假设，那就必然有猜错的时候。为了确保系统逻辑的正确，我们必须要为这种情况做好准备。

因此，尽管「乐观更新」不等接口返回就已经开始后面的流程，但还是需要通过接口的实际返回来验证之前的操作是否真的有效。如果返回结果和预期一致（大概率会是这样），则不用额外的处理；反之，就需要撤销之前的操作，并且告知用户。

## 自己搭一套乐观更新机制


