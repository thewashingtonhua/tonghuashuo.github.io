---
title: '设计一套乐观更新机制'
description: '做人呐，最重要的就是乐观啦'
tags: ['design']
cover: '../../../images/blog/blank.jpg'
series: ''
draft: true
original: true
---

## 终于，我又营业了

2020 年的上半年，比往年任何时候过得都快。转眼已经到了下半年，终于，我又营业了。

在正式开始写这篇文章之前，我还特意在百度、知乎、掘金等平台搜了一下「乐观更新」，发现相关的内容屈指可数，讲「乐观锁」的到是有不少。

那正好，就让我来填补一下这个空白吧。

## 什么是「乐观更新」

通常，客户端在发起 CRUD 请求之后，都需要等待服务端返回，然后才去更新界面。这逻辑非常合理，一点毛病没有。

唯一的缺点，就是在等待服务端响应的时间里，客户端只能空等，直观感受就是：用户从交互结束，到看到结果，中间会卡一下。稍微对用户体验有所追求的，基本都会在这个时候显示一个 Loading，让用户知道系统还在运行，没有卡住。

如果你体验过 Google 家的产品，你一定会惊叹于其交互的响应速度，那种按下按钮之后立刻得到结果的快感，宛如一个纯离线的应用，什么接口响应时间，不存在的。

Google 之所以能做到这种程度，并不是因为它是 Google —— 一个掌握着浏览器、网络协议、V8 引擎等核心技术的互联网巨头。人家的方案非常简单：不等接口返回，请求发送的同时，直接就把交互的结果体现到界面上。

这就是「乐观更新」：客户端不等待接口的返回，先行按照操作成功进行视图更新。

## 这么乐观，真的大丈夫吗？

如果接口返回了失败的结果怎么办？或者我误操作了呢？

当然，并不是所有操作都可以通过「乐观更新」的方式来实现，必须满足一些条件：

- 操作成功率非常高，几乎不可能失败
- 接口正常响应的耗时本来就很短
- 即便操作失败，或是误操作了，也可以轻易的撤销。

例如发送一条消息、删除一个文件，这些都是可以「乐观更新」的，并且能够大幅提升用户体验。

你能想象每发一条微信消息都会出现一个 Loading 的场景吗？Windows 10 已经默认把删除到回收站的确认框取消了你发现了吗？

反过来，你能想象迅雷还没开始下载就直接显示下载完毕了？或者用支付宝付款的时候，先支付成功，然后才告诉你余额不足吗？

## 自己搭一套乐观更新机制

### 不等，不是不管

### 要乐观，也要悲观
