{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/blog/2017/02/07/mysql-error-2002 copy","webpackCompilationHash":"","result":{"data":{"site":{"siteMetadata":{"title":"童话说","keywords":["tonghuashuo","github","front-end","javascript","typescript","react","node","washington","hua","童话","童话说","前端","博客","技术","计算机","互联网"]}},"markdownRemark":{"html":"<h2>起因</h2>\n<p>最近在推进公司项目架构的前后端分离，正在做一个 Demo，要用到数据库，结果不知道是不是因为最近一次 macOS 更新的原因，MySQL 启动不了，报如下报错：</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"gatsby-code-bash line-numbers\"><code class=\"gatsby-code-bash\">mysql -u myUserName -p\n<span class=\"token punctuation\">[</span>mysql<span class=\"token punctuation\">]</span>ERROR <span class=\"token number\">2002</span> <span class=\"token punctuation\">(</span>HY000<span class=\"token punctuation\">)</span>: Can<span class=\"token string\">'t connect to local MySQL server through socket '</span>/tmp/mysql.sock' <span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n<h2>寻医问药</h2>\n<p>网上转了一圈，发现解决方案一堆，似乎是个很普遍的问题。但各种说法不同，试了好多都不对症。最后花了半天时间终于找到了解决办法，这里分享下求解过程中学到的一些东西。</p>\n<h2>先说解决办法</h2>\n<p>错误提示的意思大概是围绕 <code class=\"gatsby-code-text\">/tmp/mysql.sock</code> 这么个文件， <code class=\"gatsby-code-text\">cd</code> 过去一看文件不存在，简单查了下，这个文件是在本地通过 socket 方式连接 MySQL 时自动创建的，所以应该不是文件丢失的问题，只是没能正确生成。网上的办法一种是卸载 MySQL 后重装，另一种说创建个同名的软连接指到 <code class=\"gatsby-code-text\">/var/lib/mysql/mysql.sock</code> ，前者稍后吐槽，是个巨坑，而且从目前的判断来看也不是很对症，后者看了下至少在我的设备上不存在这个路径，无果而返。</p>\n<p>继续查，看到有说用 <code class=\"gatsby-code-text\">mysqld_safe</code> 和 <code class=\"gatsby-code-text\">mysql_install_db</code> 的，看似相关但试了下并不对症。</p>\n<p>继续查，又发现一种新的方案，说在 MySQL 的配置文件 <code class=\"gatsby-code-text\">/etc/my.cnf</code> 里（没错，就是这个名字，不是 ini，也没有漏掉字母 o）设置一下 <code class=\"gatsby-code-text\">[mysqlid]</code> 下面的 socket 的指向，结果神奇的没有这个文件（稍后详解）。一番折腾弄来了这个文件，一看 <code class=\"gatsby-code-text\">socket</code> 字段前面果然一个井号注释掉了，改成 <code class=\"gatsby-code-text\">socket=/tmp/mysql.sock</code> ，保存退出，重启服务，问题依旧。</p>\n<p>整理一下情绪，继续查，这次有人把矛头指向了 PHP，说要配置 <code class=\"gatsby-code-text\">/etc/php.ini</code> ，听上去 MySQL 自身的启动应该和 PHP 无关才对，但谁能想到还真就是这里的原因。 <code class=\"gatsby-code-text\">php.ini</code> 中有三个字段与socket有关：<code class=\"gatsby-code-text\">pdo_mysql.default_socket</code>、<code class=\"gatsby-code-text\">mysqli.default_socket</code>、<code class=\"gatsby-code-text\">mysql.default_socket</code>。在我的设备上只有第一个值为 <code class=\"gatsby-code-text\">/tmp/mysql.sock</code> ，后两个都为空，全都填上之后，重启服务，绿灯！再看 <code class=\"gatsby-code-text\">/etc</code> ，顺利生成了 <code class=\"gatsby-code-text\">mysql.sock</code> 文件。</p>\n<h2>MySQL 请神容易送神难</h2>\n<p>MySQL 提供了二进制的安装包，安装非常简单，初始化的配置也不是很难，但是官方并没有提供卸载的途径，要卸载只能手动去清理一个个的目录，具体哪些目录这里就不列了，百度很容易就能查到。</p>\n<h2>macOS 不自带 /etc/my.cnf</h2>\n<p>求解过程中涉及到 MySQL 的配置文件 <code class=\"gatsby-code-text\">/etc/my.cnf</code> ，这个文件默认安装过程是没有的，如果需要对 MySQL 进行配置需要手动从 <code class=\"gatsby-code-text\">/usr/local/mysqli/support-files/my-default.cnf</code> 拷贝过来之后再编辑。这个文件中也以注释的形式写到 <code class=\"gatsby-code-text\">/etc/my.cnf</code> 是 MySQl 访问配置文件时最先查找的位置，对它的配置可以覆盖默认配置。</p>\n<h2>便捷的控制 MySQL 服务</h2>\n<p>MySQL 在安装好之后会在系统的偏好设置里有一个专门的面板，可以用来启动/停止 MySQL 服务，但作为开发者或许会更加倾向于通过命令行直接操作。（或许有更好的方法我不知道，但至少这个方法不算太糟，如果有更好方法请一定告诉我）</p>\n<p>MySQL 服务的启动命令是 <code class=\"gatsby-code-text\">/usr/local/mysql/support-files/mysql.server</code> ，后面跟参数start/stop/restart，每次都要输这么一长串太麻烦，直接写到 shell 的配置文件里作为 alias 就好了。我用的是 zsh，那就到 <code class=\"gatsby-code-text\">~/.zshrc</code> 里添加：</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"gatsby-code-bash line-numbers\"><code class=\"gatsby-code-bash\"><span class=\"token builtin class-name\">alias</span> <span class=\"token assign-left variable\">mysqlstart</span><span class=\"token operator\">=</span><span class=\"token string\">\"/usr/local/mysql/support-files/mysql.server start\"</span>\n<span class=\"token builtin class-name\">alias</span> <span class=\"token assign-left variable\">mysqlstop</span><span class=\"token operator\">=</span><span class=\"token string\">\"/usr/local/mysql/support-files/mysql.server stop\"</span>\n<span class=\"token builtin class-name\">alias</span> <span class=\"token assign-left variable\">mysqlrestart</span><span class=\"token operator\">=</span><span class=\"token string\">\"/usr/local/mysql/support-files/mysql.server restart\"</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span></span></pre></div>\n<h2>小结</h2>\n<p>配置真是一个磨人的小妖精，尤其当涉及文件众多、单个文件参数又特别繁杂的时候，在对这些参数不熟悉的前提下免不了会花大量时间在那里折腾。运维这事儿说大不大但真遇到问题了就发现其实也不容易，DevOps 难做啊。</p>","frontmatter":{"title":"解决 macOS 下 MySQL 2002 错误","description":"MySQL 真是个磨人的小妖精","cover":{"publicURL":"/static/mysql-error-2002-6f1abf9c085f6538df6bced86e008157.jpg"},"tags":["mac","mysql","2002"],"series":"","draft":false},"fields":{"id":"mysql-error-2002 copy","date":"2017-02-06T16:00:00.000Z"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/blog/2017/02/07/mysql-error-2002 copy"}}}