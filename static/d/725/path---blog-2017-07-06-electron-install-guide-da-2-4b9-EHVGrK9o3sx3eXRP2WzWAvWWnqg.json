{"data":{"site":{"siteMetadata":{"title":"童话说","keywords":["tonghuashuo","github","front-end","javascript","typescript","react","node","washington","hua","童话","童话说","前端","博客","技术","计算机","互联网"]}},"markdownRemark":{"html":"<h2>Electron</h2>\n<p>JS 越来越浪了，区区浏览器已经管不了这孩子了，一个没看住，就已经浪到原生客户端的地盘上去了，一边是开着 React Native 去找 iOS 和 Android 搞事情，一边又开着 Electron 想去单挑 WPF 和 Mac，甚至还准备响应“一带一路”帮帮好基友 Linux。</p>\n<p>不过浪太大，总有翻船的时候，Electron 上的坑还是比较多的，比如安装……是的，从安装开始就是坑。今天说的这个坑其实很早就遇到，不过当时一心等官方给方案，等了好久都没有结果，于是被迫自己动手。这片博文，一方面记录一下方案的细节，估摸着以后版本更新时候还会用到，到时能再翻出来看看，另一方面也给大家分享一下，虽然 Github 上挂着相关的 Issue，不过我知道大部分国内开发者其实是不会主动去看的。</p>\n<h2>Electron 的安装</h2>\n<p>Electron 通过 npm 进行安装，和其他 npm 上的包没什么两样：</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"gatsby-code-bash line-numbers\"><code class=\"gatsby-code-bash\"><span class=\"token function\">npm</span> i -D electron\n// 或者\nyarn add electron</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span></span></pre></div>\n<p>理论上只要这样两行命令，剩下的都是自动的，不过就是在这里，问题来了。</p>\n<h2>入坑</h2>\n<p>大部分开发者都会遇到这样一个问题：安装 Electron，npm 命令结束，开始执行本地安装脚本，到执行 <code class=\"gatsby-code-text\">node install.js</code> 这一步时候卡住不动，或是直接报错退出。</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3de0a5792e1ca0ead606d67fe546b519/ede1b/error-screenshot.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 631px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 108.71632329635499%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAYAAADAQbwGAAAACXBIWXMAAAsSAAALEgHS3X78AAAC20lEQVQ4y51Ua5OiQAxUEBRRkZeAq4ICgii+bu///7RcOgh1ntZu7X1IDcxAT9LdSc/0prRYBOS6Ljm2Q7PZjKZT7C1oNBpRr9f7WRSHko7HIy2XSwqDkIIgoMlkQp7nUcCg87lNnuvJBb7vk+O4cvl8PpfLXwBxEDHYZr2RnwCIjB3bFoBALglptVrRx8eHXBxFkXw7UAevgLb8uKAwDCUrTdMkBoMBqYoiK0LXdRoOh0/nb0tGRnGcCGDAmUXR8pFlU6Ln+XKR4zgC+C2H4/FY+NB17ecCvAvwgsx2ux1nGlOWZvyc0pbfI846CiPhcLvdSiVpmsr5erWmJOF3/g57SbKlNevQ22xiKg4VVax0WZR8mFFVHRk4pSzLRABUgZJRiWUhLOEQK/YbStxGdY838sDnjLYCgEwB0AqhsDA/Kvl+OtHvoUIn60TFbk9ZnoltIAwEwa14FtG4dGTke76spmnK2lYhgMd9TteRRrmWU7phbjYbUlX1/0WZcVfYSo8swyL30QXgCd2CDGCVMa/m2OyowI/9fr+LJ8Cc1SuHKgVcElRDJxj8I/oZgAAwzQa8K+uruLG6v0aq2GMZRV3rRVEo5kZIj/MKvlrDh/w9eEVFivJXlnVR0OdYo4qtgyFR7AuxTX2qqSxLKgpEQdfLlfJ8L3tHFhLf1vWF7vf7c1OkLEKpK5zdUoydJLGsIWeKEsElVpQMxY3vRlrBviv0Plkzi3ZsahgamYBLgNk8vjAnYerW3DoPB4iFc8MwnufmtaroxhxiXJ3PZ7qcL9I1dV1LB7iPWQhuAdzwFwqwze/oFmTfAV4OB/o0VLn9wDyeGAy9ervd6MB8iZEZBLF4DFxQ8GKXbsCyPRz2Yev8yWQqt0O9KT83veqzRx15xvxEO2Imvm2AjAUoDE24gg+R3Y55jFkscNlMoaQrb8GZ4kKUrWlvhmzM3os8V15aNUF2GzD4lyX+E38AgSoGLh9gB3wAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"Error Screenshot\"\n        title=\"\"\n        src=\"/static/3de0a5792e1ca0ead606d67fe546b519/ede1b/error-screenshot.png\"\n        srcset=\"/static/3de0a5792e1ca0ead606d67fe546b519/ff5bf/error-screenshot.png 240w,\n/static/3de0a5792e1ca0ead606d67fe546b519/a6192/error-screenshot.png 480w,\n/static/3de0a5792e1ca0ead606d67fe546b519/ede1b/error-screenshot.png 631w\"\n        sizes=\"(max-width: 631px) 100vw, 631px\"\n      />\n  </span>\n  </a></p>\n<p>从报错信息上看，似乎是在本地文件操作上遇到了权限问题。</p>\n<p>该问题在 Github 上有对应的 Issue：<a target=\"_blank\" href=\"https://github.com/electron/electron/issues/8339\">Failed at the electron@1.4.13 postinstall script 'node install.js' #8339</a>，目前有手动解决的办法，但官方还没有给出任何的解决办法。（然而居然就这样 Close 了）</p>\n<p>一般的也就是卡在这里了，然后说好的学习 Electron 的计划就这么中断了，从入门到放弃，就这么轻松。不过既然是 JS 的问题，那么我们完全可以先去看下源码，说不定就能找到原因了呢。</p>\n<h2>出坑第一步：解决本地依赖</h2>\n<p>这是我自己探索发现的一个解决办法，对发文当天及之前的版本都是有效的，后续版本如果依然遇到该问题可以参考该方案，原理上应该是一样的，但具体细节上不保证完全一致，毕竟版本更新了。</p>\n<p>先执行常规的 npm 安装。</p>\n<p>当要执行到 <code class=\"gatsby-code-text\">node install.js</code> 的时候，赶紧按下 <code class=\"gatsby-code-text\">Ctrl + C</code> 结束掉进程。别担心，到这里为止我们需要的内容已经都拿到了，剩下的我们手动来解决。（这一步的时机可能需要多试几次才能掐准，有点像 Windows 开机进 BIOS 的感觉，早了必要的文件还没下载完，晚了就错过了。实践发现报错的同时会把已经下载的内容连同 electron 目录一起删掉，按照报错信息会找不到文件，所以时机很重要）</p>\n<p>进入你项目根目录下的 <code class=\"gatsby-code-text\">./node_modules/electron</code> 目录，你就能看到前面报错的那个 <code class=\"gatsby-code-text\">install.js</code> 文件，找个文本编辑器打开看下，其实没几行代码，就做两件事：下载 Electron 的发行包（一个zip压缩包），然后解压。既然是这里面报的错，那么我就来看看代码，到底怎么回事。</p>\n<p>报错信息提示问题在第 22 行： <code class=\"gatsby-code-text\">throw err</code> ，我们先来看一下。</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/05db2150a5f5d1bec0a57d351606420d/6228b/code-screenshot-01.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 718px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 12.674094707520892%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsSAAALEgHS3X78AAAAl0lEQVQI103M2QrCMBAF0P5Hk1qjmSVbFyyI4oP4/990TYMUHw5zB+5MR17AeYVMN+iygUKCqILSAkkTYgwVoRRGzqHKiIHg2GMsAU5+9/MGLSs6XWbI84Htecfr84aXWnIOV4mgmpkJIh4heKhypW1vD5VwYYbX1Pr7bTeeR9jB4lQNlTUG1u6zh2lM0/fmyDv7xxzdHl/aHlZX8hCDKgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"22行\"\n        title=\"\"\n        src=\"/static/05db2150a5f5d1bec0a57d351606420d/6228b/code-screenshot-01.png\"\n        srcset=\"/static/05db2150a5f5d1bec0a57d351606420d/c0baa/code-screenshot-01.png 240w,\n/static/05db2150a5f5d1bec0a57d351606420d/4aa1c/code-screenshot-01.png 480w,\n/static/05db2150a5f5d1bec0a57d351606420d/6228b/code-screenshot-01.png 718w\"\n        sizes=\"(max-width: 718px) 100vw, 718px\"\n      />\n  </span>\n  </a></p>\n<p>22 行的作用似乎是检测到已安装的版本后，直接结束进程。不清楚为什么会判断我已经安装过，但是可以肯定的是，为了验证方法的可行性，我特地把之前安装的内容彻底卸载之后重新安装的，所以这个肯定不对，于是乎再来搜一下 <code class=\"gatsby-code-text\">throw err</code> ，发现在第 46 行定义了一个 <code class=\"gatsby-code-text\">onerror</code> 函数（每个人的报错信息似乎都有些不太一样，可能和具体版本有关，Github Issue 上有看到直接提示第 46 行的），而该函数只有在第 36 行定义的 <code class=\"gatsby-code-text\">extractFile</code> 函数中用到，既然如此，那应该就是在第二步解压文件的时候出了问题。</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b7541ea79d9a9bde5a2aac82658a8102/40499/code-screenshot-02.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 760px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 38.15789473684211%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAABNElEQVQoz42S646CMBSEeQ96L7QCChERWS7qj33/V5odjEbNbsz+mPSclnydMyUx1sLkDj5ahMIg2zjYzMJvctYZrFPsNQzlgob1ClIISCkpBaXUrV7XVYnLAnbdjG44YZlGTHOL7mtAO11QNQ1BFtoZeEsYV2XYU8aYO/QJuwGN1ugPDYbzGf3wjfl0xPVywnH8QqgCfFMhlhG7mCNWNXzVIa/2yIstnM8If4JXJYrAIpYYxgHj0GPpJyzLHofrgpJ9QVdbRpKFiFC3KJoWPpTQWYVQ1gjcf3PonEOxiaRrCEoKCa0VHLO1vF3wVvFwIFKINGUtoKhHlu9A2pbWMROGTjfWeR4Q/sfHr5Kv9evIzvNR6hnN4YiKmcVyC0t3n2CflNxGo6N15DQV95Hkr9/hv/oBH6jhjM9M2BQAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"46行\"\n        title=\"\"\n        src=\"/static/b7541ea79d9a9bde5a2aac82658a8102/40499/code-screenshot-02.png\"\n        srcset=\"/static/b7541ea79d9a9bde5a2aac82658a8102/31cb0/code-screenshot-02.png 240w,\n/static/b7541ea79d9a9bde5a2aac82658a8102/ebafe/code-screenshot-02.png 480w,\n/static/b7541ea79d9a9bde5a2aac82658a8102/40499/code-screenshot-02.png 760w\"\n        sizes=\"(max-width: 760px) 100vw, 760px\"\n      />\n  </span>\n  </a></p>\n<p>既然如此，我们就手动去解压这个文件。不过在此之前，我们得先去下载发行包。下载发行包的过程也是在 <code class=\"gatsby-code-text\">install.js</code> 中执行的，由于之前我们手动结束了进程，这个过程也就没跑完。如果你遇到的情况是在 <code class=\"gatsby-code-text\">node install.js</code> 时卡住，那其实就是在等待下载发行包，等看到报错信息时，发行包实际上就已经下载好了，可以直接拿来用（取决于你使用的版本，可能在 <code class=\"gatsby-code-text\">~/.electron</code> 或 <code class=\"gatsby-code-text\">./node_modules/electron/.electron</code> 目录下）。不过下载过程没有进度，不知道什么时候能完，不如自己手动去下。</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/6b8278d5de2d5ee4184e7f35e41d69d7/ba552/code-screenshot-03.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 807px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 25.27881040892193%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsSAAALEgHS3X78AAAA6klEQVQY032Q2W7CMBBF8x/xMo6dYOIsLA1lK1So/f9POjURoD5UfTjyWLauzp1CRKi8o2l9Pg1WNC4YjFGoskSpEq11vpsZrc1r/ovCWqFLDdfTirge8F1L3SZCTNRpoEkj1to5VJv/w+5/CnGOGDzXIdKfD8TbJ/H9wHD+pj/eWG4PiK/RKltmtFKz9cyvBs8WhRVHWtRcpjXTcaLdb9h9nJguX7wdr4ybifV2y3430o4JaRcP8xVNt2KR5xDCq0Vx36H3ntjnyt1IlVcgWmEfiDU4sbhKsJXDuPxe+WwdcNlcXDWHPSv/AI2Vjnc4LR2kAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"download\"\n        title=\"\"\n        src=\"/static/6b8278d5de2d5ee4184e7f35e41d69d7/ba552/code-screenshot-03.png\"\n        srcset=\"/static/6b8278d5de2d5ee4184e7f35e41d69d7/e195c/code-screenshot-03.png 240w,\n/static/6b8278d5de2d5ee4184e7f35e41d69d7/21fd9/code-screenshot-03.png 480w,\n/static/6b8278d5de2d5ee4184e7f35e41d69d7/ba552/code-screenshot-03.png 807w\"\n        sizes=\"(max-width: 807px) 100vw, 807px\"\n      />\n  </span>\n  </a></p>\n<p>发行包很好找，直接到 Github 上搜“electron/electron”，到 Release 面板下，下载对应平台的最新版本即可（没有特殊需求的话就下不带后缀的版本就好了）。</p>\n<p>下载完成后解压到项目根目录下的 <code class=\"gatsby-code-text\">./node_modules/electron</code> 目录，重命名为dist。</p>\n<p>在项目根目录下的 <code class=\"gatsby-code-text\">./node_modules/electron</code> 目录中新建一个 <code class=\"gatsby-code-text\">path.txt</code> 文件，写入内容“dist/Electron.app/Contents/MacOS/Electron”（这里以 macOS 为例，Windows 和 Linux 平台的内容略有差异，具体内容可以从前面的 install.js 文件最末尾看到）</p>\n<blockquote>\n<p>2018-10-06：Electron 3.0 对 path 的取值做了些许调整，改成了“Electron.app/Contents/MacOS/Electron”</p>\n</blockquote>\n<p>至此，本地依赖就安装完成了。在项目根目录下执行 <code class=\"gatsby-code-text\">./node_modules/electron/dist/Electron.app/Contents/MacOS/Electron .</code> 就可以运行 App 了。当然聪明的朋友肯定知道用 <code class=\"gatsby-code-text\">package.json</code> 里的 <code class=\"gatsby-code-text\">scripts</code> 字段来简化这段命令。</p>\n<p>然后就可以通过 <code class=\"gatsby-code-text\">npm run start</code> 来启动了。</p>\n<h2>出坑第二步：解决全局命令</h2>\n<p>安装完本地依赖后，其实就已经可以正常使用了，该有的功能一个不少。但是如果我们希望 <code class=\"gatsby-code-text\">electron</code> 命令能够全局使用，我们还需要全局安装一下。</p>\n<p>方法其实跟本地安装时一样的，只有两点区别：</p>\n<ul>\n<li>npm 执行全局安装 <code class=\"gatsby-code-text\">sudo npm i -g electron</code></li>\n<li>原本在项目根目录下的操作，全部转移到 Node.js 的全局模块所在位置，如果你没有修改过的话，默认是 <code class=\"gatsby-code-text\">/usr/local/lib/node_modules/electron</code> （这里以 Mac 为例，不同平台具体位置可能会有差异）。</li>\n</ul>\n<h2>另一种思路</h2>\n<p>其实在探索过程中，我们看到了 Electron 的发行包中提供了 <code class=\"gatsby-code-text\">Electron.app</code> 文件（在 Windows 下是同名的 exe 文件），通过命令行启动实际运行的也是它，那我们其实完全可以直接运行这个程序。在 Terminal/命令提示符 中配置一个 alias，让 <code class=\"gatsby-code-text\">electron</code> 命令指向对应的可执行文件即可。</p>\n<p>当然这个方案有一个很明显的缺点，就是脱离了 npm 的管理，开发过程中如果需要查看/升级版本相关信息就没那么方便了。</p>\n<h2>更新</h2>\n<p>更新的方式其实和安装一样，当通过 yarn 或是 npm 发现有可用更新时，直接去官网下载最新啊 release 包，解压后覆盖原有的内容即可，必要时候手动更新一下 package.json 文件里的版本号即可。</p>\n<h2>后记（2018-12-10）</h2>\n<p>时至今日，Electron 都快发布 4.0 了，这个问题还是如此。从第一次发布这篇文章到现在，我更新过 node 版本，换过网络环境，换过电脑，但始终都会遇到这个问题。所以我很难想象那些成功安装的人是怎么做到的。</p>\n<p>比较意外的是，当我某一次尝试 cnpm 的时候，竟然奇迹般的一边安装成功，但使用 yarn 和 npm 时从未成功过（日常一直都是用的淘宝的源，为测试也用过官方的源，但都不行）。</p>","frontmatter":{"title":"Electron 安装出坑指南","description":"世界本无坑，用的人多了，也就有了坑","date":null,"cover":{"publicURL":"/static/electron-a9838665d68ab68d327e48d8720bac3f.jpg"},"tags":["electron"],"series":null,"draft":null},"fields":{"id":"electron-install-guide","date":"2017-07-05T16:00:00.000Z"}}},"pageContext":{"slug":"/blog/2017/07/06/electron-install-guide"}}