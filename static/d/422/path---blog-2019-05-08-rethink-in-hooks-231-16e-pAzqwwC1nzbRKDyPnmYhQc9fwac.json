{"data":{"site":{"siteMetadata":{"title":"童话说","keywords":["tonghuashuo","github","front-end","javascript","typescript","react","node","washington","hua","童话","童话说","前端","博客","技术","计算机","互联网"]}},"markdownRemark":{"html":"<h2>为什么要重新来过？</h2>\n<p>我之前写过 <a href=\"/blog/2019/02/15/how-to-think-in-hooks\">一篇博客</a>，介绍了 Class 组件的各个生命周期钩子函数在 Hooks 中对应的方案。那时 Hooks 刚刚发布，开发者最关心的莫过于代码的迁移问题，也就是怎么把现有的 Class 组件改造成 Hooks 的方式。</p>\n<p>尽管这种方式非常的直观有效，但很快我们就发现，事情似乎没那么简单。单纯用这个思维来考虑问题，并不能很好地解释 Hooks 的一些行为，比如 <code class=\"gatsby-code-text\">useEffect</code> 中的变量有时候无法获取最新的值、命令式的回调函数也不总是按照我们的预期工作，<code class=\"gatsby-code-text\">useEffect</code> 的依赖数组好像总是缺点什么。</p>\n<p>在亲自踩了 2 个多月的坑，参与了一些 <a href=\"https://github.com/reactjs/zh-hans.reactjs.org/pull/121\" target=\"_blank\" rel=\"noopener noreferrer\">React 官网的翻译工作</a>，拜读了 <a href=\"https://overreacted.io/making-setinterval-declarative-with-react-hooks\" target=\"_blank\" rel=\"noopener noreferrer\">几篇</a> <a href=\"https://overreacted.io/react-as-a-ui-runtime\" target=\"_blank\" rel=\"noopener noreferrer\">非常好的</a> <a href=\"https://overreacted.io/a-complete-guide-to-useeffect\" target=\"_blank\" rel=\"noopener noreferrer\">博客</a> 之后，我幡然醒悟，对「如何 Think in Hooks」有了新的认识。</p>\n<p>因此这篇博客，我们来「重新 Think in Hooks」。</p>\n<h2>当我们讨论 Hooks 时，我们到底在讨论什么？</h2>\n<p>要理解 Hooks，我们得先回到 Hooks 的本质 —— 一种逻辑复用的方式。</p>\n<p>Hooks 并不是新的组件类型，当我们讨论 Hooks 时，我们讨论的其实是函数组件 —— 就是那种没有 state、没有生命周期、只是根据 props 返回相应的 JSX 的渲染函数。Hooks 的出现让函数组件可以拥有和 Class 组件一样可以拥有 state（是可以，不是必须），相应的也就有了生命周期。因此确切的说，我们是在讨论使用了 Hooks 的函数组件。</p>\n<p>但是「使用了 Hooks 的函数组件」这个词太长了，而下文我又将经常提到这个词，所以在后面的文字中，我将简单用 Hooks 来表示这个概念。</p>\n<h2>欲练此功，必先……忘记过去</h2>\n<p>当我们在使用 Class 组件时，每当 props 或 state 有更新，只有 <code class=\"gatsby-code-text\">render()</code> 函数会重新执行，其它成员函数（生命周期函数除外）并不会因此而重新执行。这个逻辑放到 Hooks 里是行不通的，这也是很多问题产生的根源。</p>\n<p>所以要想真正实现 Think in Hooks，首先你得忘记如何 Think in Class。</p>\n<h2>为什么我的 state 会不更新？</h2>\n<h3>Cheap Talk</h3>\n<p>Hooks 的本质是一个渲染函数，就像是 Class 组件的 <code class=\"gatsby-code-text\">render()</code> 函数一样。</p>\n<p><code class=\"gatsby-code-text\">render()</code> 函数在运行时会根据那一次的 props 和 state 去渲染。如果在 <code class=\"gatsby-code-text\">render()</code> 函数运行期间 props 或是 state 再次发生变化，并不会影响这一次的执行，而是会触发新一轮的渲染，<code class=\"gatsby-code-text\">render()</code> 再一次被调用，并且这一次传入的是变化后的 props 和 state。</p>\n<p>到这里我们得出结论：</p>\n<blockquote>\n<p><code class=\"gatsby-code-text\">render()</code> 函数中用到的 props 和 state 在函数执行的一开始就已经被确定了。 —— 记住这一点</p>\n</blockquote>\n<h3>The Code</h3>\n<p>好了，理论说得够多了，我们来看代码吧。假设我们有这样一个组件：</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre style=\"counter-reset: linenumber NaN\" class=\"gatsby-code-jsx line-numbers\"><code class=\"gatsby-code-jsx\"><span class=\"token keyword\">function</span> <span class=\"token function\">Counter</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>count<span class=\"token punctuation\">,</span> setCount<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">function</span> <span class=\"token function\">onClick</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">setCount</span><span class=\"token punctuation\">(</span>count <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2000</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>p</span> <span class=\"token attr-name\">onClick</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>onClick<span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">You clicked </span><span class=\"token punctuation\">{</span>count<span class=\"token punctuation\">}</span><span class=\"token plain-text\"> times</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>p</span><span class=\"token punctuation\">></span></span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>等价的 Class 组件实现可以是下面这样：</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre style=\"counter-reset: linenumber NaN\" class=\"gatsby-code-jsx line-numbers\"><code class=\"gatsby-code-jsx\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">Counter</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Component</span> <span class=\"token punctuation\">{</span>\n  state <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    count<span class=\"token punctuation\">:</span> <span class=\"token number\">0</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token function-variable function\">onClick</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> count<span class=\"token punctuation\">:</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">.</span>count <span class=\"token operator\">+</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2000</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token function\">render</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>p</span> <span class=\"token attr-name\">onClick</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>onClick<span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">You clicked </span><span class=\"token punctuation\">{</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">.</span>count<span class=\"token punctuation\">}</span><span class=\"token plain-text\"> times</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>p</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>对比一下两段函数，如果把 Class 的语法中的所有东西全部塞到 <code class=\"gatsby-code-text\">render()</code> 函数里，然后把 <code class=\"gatsby-code-text\">render()</code> 函数单独拎出来，给变量和函数换个名字 —— 恭喜你，你得到了一个等效的 Hooks ！。</p>\n<p>开玩笑的，但这真的很像对不对。</p>\n<p>现在考虑一个问题：如果我在 2 秒内连续点击组件 3 次，那么到第 5 秒的时候，组件会显示什么？</p>\n<p>在类组件的实现中，结果是 3，因为触发了 3 次更新，每次都在原有的基础上加 1。</p>\n<p>但在 Hooks 的实现中，你会发现，结果意外地变成了 1。很奇怪对不对，明明是一样的逻辑，为什么结果不一样？（我向你保证这跟闭包没有关系）</p>\n<p>但如果你在 <code class=\"gatsby-code-text\">onClick</code> 函数中 <code class=\"gatsby-code-text\">console.log</code> 一下，你会发现点击事件确实被触发了 3 次，但是 3 次 <code class=\"gatsby-code-text\">count</code> 的值一样。</p>\n<p>这是为什么？</p>\n<p>还记得我们前面所说的吗？「<code class=\"gatsby-code-text\">render()</code> 函数中用到的 props 和 state 在函数执行的一开始就已经被确定了」。为了简化问题，我们可以把 Hooks 的代码中所有用到的 props 和 state 直接替换成那一次的取值：</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre style=\"counter-reset: linenumber NaN\" class=\"gatsby-code-jsx line-numbers\"><code class=\"gatsby-code-jsx\"><span class=\"token comment\">// 第一次渲染</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">Counter</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 这里是对 useState 的等价替换</span>\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">const</span> count <span class=\"token operator\">=</span> <span class=\"token number\">0</span></span>\n  <span class=\"token keyword\">function</span> <span class=\"token function\">onClick</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">      <span class=\"token function\">setCount</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span></span>    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2000</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">return</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>p</span> <span class=\"token attr-name\">onClick</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>onClick<span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">You clicked 0 times</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>p</span><span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>注意到第 8 行的变化了么？这就是为什么。在这 2 秒钟之内，无论点击多少次，我们都是在给组件下达同样的指令：2 秒钟后把 <code class=\"gatsby-code-text\">count</code> 设置为 1。2 秒之后组件或许会被更新多次，但结果都是一样的。<code class=\"gatsby-code-text\">onClick</code> 函数中 <code class=\"gatsby-code-text\">count</code> 的值在函数执行的一开始就已经被确定了。</p>\n<blockquote>\n<p>这里有一个细节，如果你碰巧真的运行了刚才的代码，你或许会注意到，不管我们在 2 秒之内点击了组件多少次，点击事件和 <code class=\"gatsby-code-text\">setTimeout</code> 会执行同样的次数，但组件最多更新 2 次。这应该是 React 自身的一种优化机制吧。</p>\n<p>在写这个 Demo 时我所用的 React 版本是 16.8.6，我并不清楚这个特性是从哪个版本开始加入的，但这确实是个不错的特性。</p>\n</blockquote>\n<p>那如果我想实现 Class 版本的那种效果要怎么办？可以通过给 <code class=\"gatsby-code-text\">setCount()</code> 传入一个回调函数来解决：</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre style=\"counter-reset: linenumber NaN\" class=\"gatsby-code-jsx line-numbers\"><code class=\"gatsby-code-jsx\"><span class=\"token keyword\">function</span> <span class=\"token function\">Counter</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>count<span class=\"token punctuation\">,</span> setCount<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">function</span> <span class=\"token function\">onClick</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">      <span class=\"token function\">setCount</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">c</span> <span class=\"token operator\">=></span> c <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span></span>    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2000</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>p</span> <span class=\"token attr-name\">onClick</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>onClick<span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">You clicked </span><span class=\"token punctuation\">{</span>count<span class=\"token punctuation\">}</span><span class=\"token plain-text\"> times</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>p</span><span class=\"token punctuation\">></span></span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这里表示不管 count 现在的值是多少，往上加一就好了。Class 组件中的 <code class=\"gatsby-code-text\">setState()</code> 函数也有同样的写法，虽然它俩的目的并不相同。</p>\n<h2>永远对 useEffect 的依赖数组保持诚实</h2>\n<p>这就是为什么我们经常会遇到 useEffect 里的值</p>\n<h2>如何在 Hooks 中请求数据</h2>\n<h2>如何实现 <code class=\"gatsby-code-text\">setInterval()</code></h2>\n<h2>小结</h2>\n<p>第一次看到官方文档中的「It takes a bit of a mindshift to start “thinking in Hooks”」这句话的时候，我并没有太当回事，觉得无非就是有一样新东西要学而已。</p>","frontmatter":{"title":"重新 Think in Hooks","description":"忘记过去之所学，我们从头来过","cover":{"publicURL":"/static/think-in-hooks-again-f9fcd719dcab55af4a1ad3d3cfbe0585.jpg"},"tags":["react","hooks"],"series":"","draft":true},"fields":{"id":"rethink-in-hooks","date":"2019-05-07T16:00:00.000Z"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/blog/2019/05/08/rethink-in-hooks"}}