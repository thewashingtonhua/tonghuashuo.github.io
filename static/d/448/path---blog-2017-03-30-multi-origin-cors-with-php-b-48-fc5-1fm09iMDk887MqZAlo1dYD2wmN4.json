{"data":{"site":{"siteMetadata":{"title":"童话说","keywords":["tonghuashuo","github","front-end","javascript","typescript","react","node","washington","hua","童话","童话说","前端","博客","技术","计算机","互联网"]}},"markdownRemark":{"html":"<p>CORS 本不是什么新鲜事，也不是特别的难，但最近遇上一个跨域的问题，后端人员是个新手没经验，靠不住，没办法只好自己上。这里权当是个记录。</p>\n<p>问题其实很简单，PHP 接口层实现 CORS 允许多个指定源访问（局域网地址、应用服务器域名等），直接上代码：</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre style=\"counter-reset: linenumber NaN\" class=\"gatsby-code-php line-numbers\"><code class=\"gatsby-code-php\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function\">test</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 获取请求的 origin 字段</span>\n  <span class=\"token variable\">$origin</span> <span class=\"token operator\">=</span> <span class=\"token function\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_SERVER</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'HTTP_ORIGIN'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> <span class=\"token variable\">$_SERVER</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'HTTP_ORIGIN'</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">:</span> <span class=\"token single-quoted-string string\">''</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// 这里指定了允许访问的源</span>\n  <span class=\"token variable\">$origins_allowed</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span>\n    <span class=\"token single-quoted-string string\">'http://app1.example.com'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token single-quoted-string string\">'http://app2.example.com'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token single-quoted-string string\">'http://localhost:8080'</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// 如果请求源在上面的列表中，设置允许访问</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">in_array</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$origin</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$origins_allowed</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">header</span><span class=\"token punctuation\">(</span><span class=\"token single-quoted-string string\">'Access-Control-Allow-Origin: '</span><span class=\"token punctuation\">.</span><span class=\"token variable\">$origin</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">/* ============================================================ */</span>\n  <span class=\"token comment\">/* 以上内容可以提取成公共部分，下面代码建议根据接口具体需求单独设置 */</span>\n  <span class=\"token comment\">/* ============================================================ */</span>\n\n  <span class=\"token comment\">// 其他请求头：允许字段、允许Cookie等，根据需要设置</span>\n  <span class=\"token function\">header</span><span class=\"token punctuation\">(</span><span class=\"token double-quoted-string string\">\"Access-Control-Allow-Headers: Origin, X-Requested-With, Content-Type, Accept\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">header</span><span class=\"token punctuation\">(</span><span class=\"token single-quoted-string string\">'Access-Control-Allow-Credentials: true'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">header</span><span class=\"token punctuation\">(</span><span class=\"token single-quoted-string string\">'Access-Control-Allow-Methods: GET, PUT, POST, DELETE, OPTIONS'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// 返回响应内容</span>\n  <span class=\"token variable\">$data</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token single-quoted-string string\">'data'</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token single-quoted-string string\">'hello'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token variable\">$this</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">response</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$data</span><span class=\"token punctuation\">,</span> <span class=\"token double-quoted-string string\">\"json\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>","frontmatter":{"title":"PHP 处理多源 CORS 的解决办法","description":"一个老生常谈的话题，碰到了顺便记录一下","date":"2017-03-30","cover":{"publicURL":"/static/cors-77fc63594cf3a06c31921df671acd258.jpg"},"tags":["php","cors"],"series":null,"draft":null},"fields":{"id":"multi-origin-cors-with-php"}}},"pageContext":{"slug":"/blog/2017/03/30/multi-origin-cors-with-php"}}